from scripts.util import read_supertopics, SuperTopic, get_spottopics, DateFormat, read_temp_dist, smooth
from typing import Literal, Optional
import numpy as np
from matplotlib import pyplot as plt
import re
import seaborn as sns
import csv
from itertools import chain, repeat
import pandas as pd
from sklearn.neighbors import KernelDensity
from multiprocessing import Pool
import json
from matplotlib.patches import Polygon
import matplotlib.path as mplPath
from tqdm import tqdm

FILE_TSNE = 'data/geoengineering/layout_tsne.npy'

print('Reading tsne...')
with open(FILE_TSNE, 'rb') as f:
    TSNE_FULL = np.load(f)
EPS = 1e-12

paths_tim = [
    [[8.94193548387097, 4.6103896103896105], [5.458064516129028, 5.2597402597402585],
     [5.690322580645159, 3.506493506493509], [8.090322580645164, 0.9090909090909101],
     [11.264516129032259, 1.2337662337662358], [12.65806451612903, 4.675324675324674]],
    [[9.096774193548384, 11.94805194805195], [5.148387096774194, 7.727272727272727], [7.316129032258068,
                                                                                      5.3896103896103895], [
         12.348387096774196, 5.064935064935064], [14.283870967741933, 9.545454545454547], [12.812903225806451,
                                                                                           12.20779220779221]],
    [[3.212903225806457, 13.246753246753247], [5.148387096774194, 10.90909090909091], [7.238709677419351,
                                                                                       11.2987012987013], [
         5.845161290322579, 13.051948051948052]],
    [[11.961290322580645, 0.2597402597402585], [13.509677419354844, -1.8181818181818201], [15.21290322580645,
                                                                                           -0.5194805194805205], [
         13.819354838709678, 1.3636363636363633]],
    [[12.735483870967741, -2.7272727272727266], [14.980645161290319, -7.337662337662337], [19.935483870967744,
                                                                                           -5.194805194805198], [
         18.774193548387096, -0.06493506493506374]],
    [[21.483870967741936, -6.753246753246756], [21.329032258064515, -9.350649350649348], [24.425806451612907,
                                                                                          -9.350649350649348], [
         24.89032258064516, -6.103896103896105]],
    [[11.34193548387097, -9.285714285714285], [10.258064516129032, -12.532467532467535], [19.31612903225806,
                                                                                          -13.181818181818187], [
         20.63225806451613, -10.649350649350644]],
    [[5.92258064516129, -3.4415584415584384], [5.92258064516129, -6.428571428571427], [7.238709677419351,
                                                                                       -9.155844155844157], [
         11.806451612903224, -7.142857142857146], [11.65161290322581, -4.155844155844157], [9.251612903225805,
                                                                                            -2.7272727272727266]],
    [[-6.309677419354838, -7.987012987012989], [-7.8580645161290334, -9.935064935064936], [-4.9935483870967765,
                                                                                           -12.532467532467535], [
         -4.916129032258063, -14.155844155844157], [-2.9806451612903224, -14.545454545454547], [-3.677419354838708,
                                                                                                -8.831168831168831]],
    [[-1.9741935483870954, -11.038961038961034], [-1.4322580645161302, -13.441558441558442], [0.5806451612903203,
                                                                                              -12.272727272727273], [
         2.051612903225802, -9.350649350649348], [0.11612903225806548, -9.090909090909086]],
    [[-4.683870967741935, -0.9090909090909101], [-6.387096774193548, -3.4415584415584384], [-3.21290322580645,
                                                                                            -4.935064935064936], [
         3.987096774193546, -0.12987012987013102], [1.0451612903225822, 2.8571428571428577]],
    [[-3.3677419354838705, 8.311688311688311], [-3.21290322580645, 6.688311688311689], [-0.3483870967741929,
                                                                                        6.688311688311689], [
         -0.9677419354838719, 9.220779220779221]],
    [[-8.55483870967742, 14.74025974025974], [-8.167741935483871, 9.87012987012987], [-5.303225806451614,
                                                                                      10.584415584415584], [
         -3.909677419354839, 14.220779220779221]],
    [[-9.329032258064515, 8.051948051948052], [-11.419354838709676, 7.662337662337663], [-11.032258064516132,
                                                                                         6.493506493506494], [
         -7.393548387096775, 5.974025974025974], [-6.387096774193548, 8.961038961038962]],
    [[-8.01290322580645, 4.6103896103896105], [-6.232258064516131, 0.5844155844155843], [-4.529032258064518,
                                                                                         -0.12987012987013102], [
         -1.5870967741935473, 1.6233766233766254], [-0.50322580645161, 4.220779220779221], [-5.225806451612904,
                                                                                            5.3896103896103895]],
    [[-17.53548387096774, 4.675324675324674], [-15.83225806451613, 2.1428571428571423], [-13.974193548387099,
                                                                                         3.701298701298704], [
         -14.980645161290324, 5.1298701298701275]],
    [[-21.174193548387095, 2.9870129870129887], [-19.470967741935482, 0.3896103896103895], [-16.683870967741935,
                                                                                            1.8831168831168839], [
         -19.39354838709677, 3.506493506493509]],
    [[-12.348387096774193, 6.1688311688311686], [-11.729032258064517, 0.9740259740259738], [-8.245161290322578,
                                                                                            1.688311688311689], [
         -7.8580645161290334, 5.584415584415584]],
    [[-13.045161290322579, 0.5844155844155843], [-11.806451612903224, -2.467532467532468], [-8.245161290322578,
                                                                                            -0.5844155844155807], [
         -8.400000000000002, 1.2337662337662358]],
    [[-16.529032258064518, 1.558441558441558], [-17.69032258064516, -0.45454545454545325], [-15.987096774193548,
                                                                                            -3.051948051948049], [
         -12.193548387096776, -2.7922077922077904], [-13.819354838709678, 0.7142857142857153]],
    [[-15.754838709677419, -3.5714285714285694], [-14.825806451612902, -7.272727272727273], [-12.58064516129032,
                                                                                             -5.974025974025977], [
         -12.890322580645162, -7.20779220779221], [-10.954838709677418, -7.337662337662337], [-10.567741935483873,
                                                                                              -5.779220779220779], [
         -8.709677419354836, -4.805194805194805], [-8.400000000000002, -1.3636363636363598], [-12.038709677419355,
                                                                                              -2.9870129870129887]],
    [[-19.238709677419354, -1.9480519480519476], [-17.69032258064516, -3.506493506493509], [-16.606451612903225,
                                                                                            -3.051948051948049], [
         -17.45806451612903, -1.688311688311689]],
    [[-17.612903225806452, -3.961038961038959], [-16.451612903225808, -4.935064935064936], [-15.754838709677419,
                                                                                            -4.675324675324678], [
         -15.90967741935484, -3.506493506493509]],
    [[4.993548387096773, 17.337662337662337], [6.07741935483871, 15.519480519480519], [7.8580645161290334,
                                                                                       15.714285714285714], [
         7.083870967741937, 17.272727272727273]],
    [[-12.735483870967744, -9.740259740259738], [-13.35483870967742, -12.4025974025974], [-11.651612903225807,
                                                                                          -12.272727272727273], [
         -11.032258064516132, -10.129870129870127]],
    [[-2.516129032258064, 13.96103896103896], [-2.0516129032258057, 12.077922077922079], [-0.1935483870967758,
                                                                                          12.532467532467532], [
         -1.0451612903225787, 14.025974025974026]],
    [[-4.296774193548387, 11.03896103896104], [-4.606451612903225, 9.805194805194805], [-2.903225806451612,
                                                                                        10.064935064935066], [
         -2.361290322580647, 11.233766233766234]]
]
paths_finn = [
    [[12.116129032258065, -7.922077922077925], [10.412903225806453, -9.805194805194809],
     [11.41935483870968, -12.467532467532465], [14.903225806451616, -14.220779220779221],
     [20.245161290322578, -14.415584415584412], [21.096774193548384, -10.649350649350644]],
    [[21.561290322580646, -6.428571428571427], [25.200000000000003, -5.714285714285715],
     [25.509677419354837, -8.116883116883116], [23.26451612903226, -10.584415584415588],
     [21.329032258064515, -9.220779220779221]],
    [[12.116129032258065, -2.467532467532468], [14.670967741935485, -7.077922077922075],
     [19.16129032258064, -7.272727272727273], [19.238709677419358, -3.311688311688311],
     [17.92258064516129, 0.3896103896103895]],
    [[12.50322580645161, 2.012987012987015], [16.141935483870967, 0.2597402597402585],
     [15.44516129032258, -0.8441558441558428], [12.580645161290327, -1.9480519480519476],
     [11.41935483870968, 0.8441558441558428]],
    [[10.722580645161287, -0.7142857142857117], [13.354838709677416, -7.077922077922075],
     [7.161290322580648, -10.584415584415588], [3.29032258064516, -4.285714285714288]],
    [[4.993548387096773, 10.129870129870131], [4.529032258064511, 3.506493506493509], [7.780645161290323, 0],
     [10.412903225806453, 0.3896103896103895], [13.664516129032258, 4.545454545454543],
     [14.593548387096774, 12.012987012987015], [9.096774193548384, 13.116883116883118]],
    [[4.219354838709677, 16.103896103896105], [2.5935483870967744, 12.20779220779221],
     [5.225806451612897, 10.584415584415584], [8.864516129032253, 13.376623376623376],
     [7.238709677419351, 17.857142857142858]],
    [[-9.406451612903226, 13.506493506493507], [-8.477419354838709, 10.194805194805195],
     [-5.148387096774194, 9.61038961038961], [-2.8258064516129053, 12.922077922077921],
     [-5.458064516129031, 16.03896103896104]],
    [[-3.832258064516129, 8.961038961038962], [-3.832258064516129, 6.428571428571427],
     [0.34838709677419644, 6.2987012987013], [0.27096774193548256, 9.35064935064935],
     [-1.4322580645161302, 9.740259740259742]],
    [[-18.07741935483871, 4.935064935064933], [-16.374193548387098, 2.2727272727272734],
     [-13.741935483870968, 3.0519480519480524], [-14.206451612903225, 5.194805194805195],
     [-15.44516129032258, 5.9090909090909065]],
    [[-6.541935483870965, -7.20779220779221], [-8.709677419354836, -11.558441558441558],
     [-5.612903225806452, -16.103896103896105], [3.445161290322581, -10.974025974025977],
     [-0.11612903225806548, -7.467532467532465]],
    [[-2.4387096774193537, 0.779220779220779], [1.277419354838706, 2.4025974025974044],
     [4.219354838709677, 1.4935064935064943], [5.148387096774194, -0.9740259740259702],
     [-0.03870967741935516, -4.285714285714288], [-5.225806451612904, -5.1298701298701275],
     [-6.154838709677421, -0.9740259740259702]],
    [[-7.316129032258065, 5.2597402597402585], [-3.3677419354838705, 5.649350649350648],
     [0.11612903225806548, 4.0909090909090935], [-0.1935483870967758, 2.4025974025974044],
     [-0.9677419354838719, 1.6233766233766254], [-5.148387096774194, -0.2597402597402585],
     [-7.6258064516129025, 2.337662337662337]],
    [[-13.122580645161289, 9.480519480519481], [-8.55483870967742, 10.194805194805195],
     [-4.916129032258063, 9.285714285714286], [-5.148387096774194, 6.363636363636363],
     [-7.083870967741934, 5.2597402597402585], [-12.58064516129032, 6.753246753246753]],
    [[-12.735483870967744, 6.623376623376622], [-13.122580645161289, 1.558441558441558],
     [-7.935483870967744, 0.649350649350648], [-7.703225806451613, 5.324675324675322]],
    [[-13.122580645161289, 1.688311688311689], [-17.070967741935483, 1.8831168831168839],
     [-19.161290322580648, -1.8181818181818201], [-18.851612903225806, -7.662337662337663],
     [-13.664516129032258, -9.155844155844157], [-7.6258064516129025, -6.2987012987013],
     [-7.161290322580648, 0.12987012987013102]],
    [[-22.10322580645161, 3.6363636363636367], [-21.329032258064515, -0.12987012987013102],
     [-18.387096774193548, -0.3896103896103895], [-17.380645161290325, 2.597402597402599]]
]

paths_finn2 = [
    [[5.535483870967745, 9.61038961038961], [9.870967741935488, 13.441558441558442],
     [14.748387096774195, 12.792207792207792], [16.141935483870967, 8.441558441558442],
     [13.819354838709678, 5.194805194805195], [11.032258064516128, 5.454545454545453],
     [8.864516129032253, 4.805194805194805], [6.154838709677421, 7.012987012987011]],
    [[12.348387096774196, 5.2597402597402585], [12.967741935483872, 3.116883116883116], [11.032258064516128,
                                                                                         0.8441558441558428], [
         7.8580645161290334, 0.45454545454545325], [5.612903225806448, 2.467532467532468], [5.3806451612903246,
                                                                                            6.493506493506494], [
         6.541935483870965, 6.688311688311689], [8.864516129032253, 4.740259740259738], [11.109677419354838,
                                                                                         5.454545454545453]],
    [[14.129032258064512, 5], [15.754838709677422, 3.1818181818181834], [13.896774193548382, 2.4025974025974044], [
        12.890322580645162, 3.8961038961038987]],
    [[11.109677419354838, 0.8441558441558428], [12.425806451612907, -2.1428571428571423], [15.677419354838705,
                                                                                           -0.7142857142857117], [
         14.283870967741933, 2.2727272727272734], [12.580645161290327, 2.4025974025974044]],
    [[12.580645161290327, -2.1428571428571423], [15.677419354838705, -0.7142857142857117], [18.619354838709675, 0], [
        19.31612903225806, -2.9220779220779214], [19.858064516129033, -6.103896103896105], [15.832258064516132,
                                                                                            -8.051948051948052], [
         13.199999999999996, -5.649350649350648]],
    [[21.174193548387095, -6.103896103896105], [20.70967741935484, -8.831168831168831], [21.87096774193548,
                                                                                         -10.909090909090907], [
         24.81290322580645, -9.090909090909086], [25.587096774193547, -5.974025974025977]],
    [[10.025806451612901, -9.41558441558442], [9.56129032258064, -12.79220779220779], [13.974193548387099,
                                                                                       -14.480519480519483], [
         21.096774193548384, -14.025974025974023], [21.251612903225812, -10.649350649350644], [13.587096774193547,
                                                                                               -7.922077922077925]],
    [[7.238709677419351, -1.8181818181818201], [11.41935483870968, -1.8831168831168803], [12.812903225806451,
                                                                                          -5.779220779220779], [
         12.580645161290327, -7.922077922077925], [8.78709677419355, -10.064935064935064], [4.916129032258063,
                                                                                            -8.896103896103895], [
         4.683870967741939, -4.545454545454547]],
    [[2.3612903225806434, 12.20779220779221], [4.064516129032256, 14.025974025974026], [7.548387096774199,
                                                                                        11.623376623376625], [
         6.309677419354834, 10.454545454545455]],
    [[3.8322580645161253, 17.662337662337663], [7.161290322580648, 19.025974025974026], [9.251612903225805,
                                                                                         15.64935064935065], [
         5.92258064516129, 15]],
    [[-2.4387096774193537, 13.96103896103896], [-0.11612903225806548, 13.96103896103896], [0.03870967741935161,
                                                                                           12.272727272727273], [
         -2.516129032258064, 12.272727272727273]],
    [[-3.522580645161291, 8.961038961038962], [-3.677419354838708, 6.688311688311689], [-0.11612903225806548,
                                                                                        5.844155844155843], [
         0.27096774193548256, 8.831168831168831]],
    [[-8.941935483870967, 15.584415584415584], [-8.167741935483871, 12.142857142857144], [-3.909677419354839,
                                                                                          11.883116883116884], [
         -2.361290322580647, 15.454545454545453]],
    [[-8.167741935483871, 12.142857142857144], [-9.329032258064515, 10.77922077922078], [-5.845161290322579,
                                                                                         9.35064935064935], [
         -3.832258064516129, 11.81818181818182]],
    [[-23.18709677419355, 2.8571428571428577], [-20.32258064516129, -0.3896103896103895], [-18.46451612903226,
                                                                                           -0.12987012987013102], [
         -16.838709677419352, 2.467532467532468], [-19.39354838709677, 4.155844155844157]],
    [[-19.161290322580648, 4.545454545454543], [-17.148387096774194, 7.402597402597401], [-13.43225806451613,
                                                                                          4.740259740259738], [
         -13.664516129032258, 2.662337662337663], [-16.761290322580646, 2.4025974025974044]],
    [[-3.677419354838708, 11.753246753246755], [-1.741935483870968, 11.493506493506494], [-2.516129032258064,
                                                                                          9.675324675324676], [
         -4.9935483870967765, 10.25974025974026]],
    [[-11.961290322580645, 6.883116883116884], [-10.335483870967742, 6.1688311688311686], [-7.6258064516129025,
                                                                                           6.0389610389610375], [
         -5.458064516129031, 5.844155844155843], [-4.606451612903225, 9.285714285714286], [-6.774193548387096,
                                                                                           9.35064935064935], [
         -10.103225806451615, 10.129870129870131], [-11.883870967741935, 8.961038961038962]],
    [[-10.72258064516129, 0.9740259740259738], [-7.935483870967744, 2.7272727272727266], [-7.780645161290323,
                                                                                          5.974025974025974], [
         -10.335483870967742, 6.0389610389610375], [-11.883870967741935, 6.688311688311689], [-12.65806451612903,
                                                                                              3.441558441558442]],
    [[-7.0064516129032235, 5.194805194805195], [-4.1419354838709666, 6.428571428571427], [-0.8903225806451616,
                                                                                          4.870129870129869], [
         -0.5806451612903238, 2.2077922077922096], [-3.9870967741935495, -0.45454545454545325], [-7.8580645161290334,
                                                                                                 2.2077922077922096]],
    [[-2.129032258064516, 0.8441558441558428], [1.0451612903225822, 3.376623376623378], [4.3741935483870975,
                                                                                         1.8181818181818201], [
         4.451612903225808, -2.0129870129870113], [-0.9677419354838719, -5.9090909090909065], [-6,
                                                                                               -4.6103896103896105], [
         -4.9935483870967765, -1.2337662337662323]],
    [[-8.09032258064516, -0.06493506493506374], [-6, 0.2597402597402585], [-5.148387096774194, -1.6233766233766218], [
        -5.92258064516129, -2.9220779220779214], [-7.703225806451613, -1.7532467532467493]],
    [[-8.167741935483871, -1.8181818181818201], [-8.322580645161292, -4.805194805194805], [-6.464516129032258,
                                                                                           -5.1298701298701275], [
         -6.619354838709679, -2.6623376623376593]],
    [[-12.503225806451614, -9.220779220779221], [-13.27741935483871, -12.337662337662337], [-11.496774193548386,
                                                                                            -12.987012987012989], [
         -10.180645161290322, -9.805194805194809]],
    [[-0.8903225806451616, -9.675324675324674], [1.5870967741935509, -8.766233766233768], [2.5935483870967744,
                                                                                           -10.194805194805198], [
         1.4322580645161338, -11.558441558441558], [-0.27096774193548256, -10.974025974025977]],
    [[-1.9741935483870954, -10.649350649350644], [-0.3483870967741929, -11.233766233766232], [-0.3483870967741929,
                                                                                              -13.636363636363633], [
         -2.516129032258064, -13.701298701298704]],
    [[-5.380645161290321, -12.857142857142854], [-3.832258064516129, -12.20779220779221], [-3.445161290322581,
                                                                                           -13.441558441558442], [
         -3.909677419354839, -14.805194805194802], [-5.303225806451614, -14.350649350649356]],
    [[-6.232258064516131, -7.662337662337663], [-3.7548387096774185, -8.766233766233768], [-3.0580645161290327,
                                                                                           -11.428571428571423], [
         -3.832258064516129, -12.077922077922075], [-4.7612903225806456, -12.337662337662337], [-8.167741935483871,
                                                                                                -10]],
    [[-12.58064516129032, 0.9090909090909101], [-10.64516129032258, 0.8441558441558428], [-8.63225806451613,
                                                                                          2.0779220779220786], [
         -8.245161290322578, 0.06493506493506374], [-8.322580645161292, -2.337662337662337], [-11.729032258064517,
                                                                                              -2.6623376623376593], [
         -12.503225806451614, -0.45454545454545325]],
    [[-16.374193548387098, 2.2077922077922096], [-12.735483870967744, 0.3896103896103895], [-11.883870967741935,
                                                                                            -2.7272727272727266], [
         -16.374193548387098, -3.311688311688311], [-17.380645161290325, 0.12987012987013102]],
    [[-17.303225806451614, -0.8441558441558428], [-16.219354838709677, -3.311688311688311], [-17.612903225806452,
                                                                                             -3.7012987012987004], [
         -19.316129032258065, -2.402597402597401]],
    [[-17.380645161290325, -3.8311688311688314], [-8.322580645161292, -2.532467532467532], [-8.86451612903226,
                                                                                            -6.818181818181817], [
         -13.974193548387099, -9.220779220779221], [-17.380645161290325, -7.467532467532465]],
]
paths = paths_finn2
FILE_OUT = 'data/geoengineering/topics_finn2.npy'
polys = [mplPath.Path(np.array(p)) for p in paths]


def get_poly(pt):
    for pi, poly in enumerate(polys, start=1):
        if poly.contains_point(pt):
            return pi
    return 0


assignments = [get_poly(p) for p in tqdm(TSNE_FULL)]
with open(FILE_OUT, 'wb') as f_out:
    np.save(f_out, np.array(assignments))
